/**
 * sport calendar
 */

'use strict';

//var fileHelper = require('../fileHelper');
var Q = require('q');

var logClassEnum = require('../enum/logClass');

var Search = require('../search/search');
var statist = require('../statist');
var helper = require('../helper');


exports.generate = function (options) {
    var deferred = Q.defer();
    Search.query(options)
        .then(function (queryResult) {
            var result = [];
            var days = helper.megerLogsToDateType(queryResult, 'day');
            var statResult = statist.dispose(options, {
                days: days
            });
            statResult.days.forEach(function (day) {
                var logs = day.logs;
                var sportTime = 0;
                logs.forEach(function (log){
                    if (isSportLog(log)) {
                        sportTime += log.len;
                    }
                });
                result.push({
                    date: day.date,
                    sportTime: sportTime
                });
            });
            deferred.resolve(result);
        }).catch(function (err) {
            deferred.reject(err);
        });
    return deferred.promise;
};


function isSportLog(log) {
    var classes = log.classes;
    return classes && classes.filter(function (cls) {
        return cls.code === logClassEnum.Sport;
    }).length > 0;
}
